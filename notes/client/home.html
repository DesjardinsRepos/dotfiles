<!DOCTYPE html>
<html>
    <head>
        <title>Home</title>
        <link rel="stylesheet" href="main.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    </head>
    <body style="margin: 18vh 18vw">
        <div id="form">
            <dialog id="new-bg">
                <center>
                    <input type="text" id="new-title" placeholder="Title"></input><br>
                    <textarea placeholder="Your text" id="new-body"></textarea><br>
                    <button id="new-note-cancel" onclick="newNoteCancel()">Cancel</button>
                    <button id="new-note-submit" onclick="newNoteAdd()">Add</button><br>
                </center>
            </dialog>

            <div id="left-form">
                <img src="https://img.icons8.com/pastel-glyph/256/ffffff/plus--v2.png" 
                    style="margin: 40px 21px 10px 21px;" class="image-interact" onclick="add()" id="add">
                <img src="https://img.icons8.com/android/192/ffffff/settings.png" 
                    class="image-interact" onclick="settings()">
                <img src="https://img.icons8.com/fluent-systems-regular/144/ffffff/exit.png" 
                class="image-interact" onclick="logout()">
            </div>

            <div id="notes-container">
               
            </div>
        </div>
        <script>
            //add, settings, logout

            const newNoteAdd = () => {
                $('#new-bg')[0].style['display'] = 'none';

                createNote(
                    $('.notes-div').length,
                    $('#new-body').val(),
                    $('#new-title').val()
                );

                //$('#new-body').style['value'] = ''
                //$('#new-title').value = ''
            }

            const newNoteCancel = () => {
                $('#new-bg')[0].style['display'] = 'none';
            }

            const add = () => {
                $('#new-bg')[0].style['display'] = "inline-block";
            }


            const logout = () => {
                window.location.pathname = `${location.hostname}/signin.html`;
                deleteAllCookies();
            }

            const createNote = (index, body, title) => {
                let textarea = document.createElement("textarea");
                textarea.innerHTML = body;
                textarea.id = `notes-text-${index}`;
                textarea.className = 'notes-text';
                textarea.spellcheck = false;

                let div = document.createElement("div");
                div.id = `notes-div-${index}`;
                div.className = 'notes-div';

                let input = document.createElement("input");
                input.type = "text";
                input.value = title;
                input.id = 'notes-title';

                let expandImg = document.createElement("img");
                expandImg.src = "https://img.icons8.com/material/144/ffffff/expand-arrow--v1.png";
                expandImg.id = 'notes-expandImg';
                expandImg.onclick = () => expand(index);

                let deleteImg = document.createElement("img");
                deleteImg.src = "https://img.icons8.com/android/144/ffffff/trash.png";
                deleteImg.id = 'notes-deleteImg';
                deleteImg.onclick = () => remove(index);

                $('#notes-container').append(div);
                $(`#notes-div-${index}`).append(input, expandImg, deleteImg)
                $('#notes-container').append(textarea);
            }

            const expand = n => {
                document.getElementById(`notes-text-${n}`).style["display"] = $(`#notes-text-${n}`).css("display") === 'block' ? 'none' : 'block';
            }

            const remove = n => {
                $(`#notes-div-${n}`).remove();
                $(`#notes-text-${n}`).remove();
                // update storage
            }

            let token = document.cookie
                .split('; ')
                .find(val => val.startsWith('token='))
                .split('=')[1];

            console.log(token);

            $.ajax({
                url: "https://europe-west1-notes-synced.cloudfunctions.net/api/pullData",
                method: "POST",
                dataType: "json",
                body: "{}",
                crossDomain: true,
                contentType: "application/json; charset=utf-8",
                cache: false,
                beforeSend: xhr => {
                    xhr.setRequestHeader("Authorization", `Bearer ${token}`)
                },
                success: data => {
                    let a = JSON.parse(JSON.parse(data));

                    for(let i = 0; i < a.length; i++) {
                        createNote(
                            $('.notes-div').length,
                            a[i].body,
                            a[i].title
                        )
                    }
                },
                error: (jqXHR, textStatus, error) => {
                    console.error(error);
                }
            });

            function deleteAllCookies() { // https://stackoverflow.com/questions/179355/clearing-all-cookies-with-javascript
                var cookies = document.cookie.split(";");

                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i];
                    var eqPos = cookie.indexOf("=");
                    var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                    document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
                }
            }

            
            /*function savesnum(val) {
                document.cookie = 'snum:'+val; //Set the cookie
            }

            function getsnum() {
                var start = document.cookie.indexOf('snum:'); //Get the location of the cookie value
                var stop = document.cookie.indexOf(';'); //Get the end of the cookie value

                return document.cookie.substring(start+5, stop); //Return the value of the cookie (+5 because 'snum:' is 5 chars long)
            }*/
        </script>
    </body>
</html>